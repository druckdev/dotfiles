#!/bin/bash

## Author:  druckdev
## Created: 2020-06-14
##
## A script that deletes often used commands in a shell history.
## The script will expect a file as argument and that the history file is in the
##   format of zshs extended history.
## An automatic backup is created before deleting that can be used for recovery.

[ $# -eq 1 ] || { echo "Specify history file" >&2; exit 1; }
[ -e "$1" ] || { echo "File does not exist" >&2; exit 1; }
[ "$(stat -c '%a' "$1")" = "600" ] || { echo "File does not look like a history file" >&2; exit 1; }

declare -a COMMANDS
COMMANDS=('ls' \
          'll' \
          'l' \
          ':q' \
          ':Q' \
          'exit' \
          'cd' \
          'cd ~' \
          'cd .' \
          'cd ..' \
          'gs' \
          'git status' \
          'gd' \
          'gpush' \
          'git pull' \
          'cmake .. && make' \
          'exec zsh' \
          'python3' \
          'clear' \
)

printf '%s\n' "${COMMANDS[@]}" | column
echo "Are you a 100% sure you want to delete these commands from $1? (Type out yes)"
read yn
[ "$yn" = "yes" ] || exit 1

tempd="$(mktemp -d)"
cp "$1" "$tempd/$(basename "$1")"
echo "Backup created at $tempd/$(basename "$1")"
echo

for c in "${COMMANDS[@]}"; do
	c="$(echo "$c" | sed 's/\./\\./g; s/\//\\\//g')"
	sed -Ei "/^: [0-9]+:[0-9]+;${c}\$/d" "$1"
	echo "$c deleted"
done

echo
echo "Following commands were deleted:"
diff "$1" "$tempd/$(basename "$1")" | grep "^>" | cut -d\; -f 2 | sort | uniq -c | sort -nr
